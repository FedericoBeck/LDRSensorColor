<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">
    <style>
        .color-box {
            width: 100px;
            height: 100px;
            background-color: white;
            outline: #fff solid .5rem;
            outline-offset: 3px;
            display: inline;
            margin-right: 3rem;
        }
    </style>
</head>

<body>

    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://bulma.io">
                <h1 class="title">
                    UTN
                </h1>
            </a>
        </div>
    </nav>
    <section class="section">
        <div class="container">
            <h1 class="title is-1">
                Medici√≥n de color
            </h1>
            <div class="columns">
                <div class="column">
                    <button id="btn-trigger-measurement" class="button is-primary">Medir</button>
                </div>
                <div class="column ">
                    <div class="is-flex is-align-items-center">

                        <div class="color-box" style="background-color: #ccc"></div>
                        <div id="hexcode"><!--#hexcode--></div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <script>
        const btnTrigger = document.getElementById('btn-trigger-measurement');

        function setHexcode(hc) {
            document.getElementById('hexcode').innerText = hc;

            document.getElementsByClassName('color-box')[0].style.backgroundColor = hc
        }

        function setBtnLoading(loading) {
            if (loading)
                btnTrigger.classList.add('is-loading')
            else
                btnTrigger.classList.remove('is-loading')
        }

        window.onload = () => {
            const hexcode = document.getElementById('hexcode').innerText;
            console.log(hexcode);

            document.getElementsByClassName('color-box')[0].style.backgroundColor = hexcode
        }

        async function triggerMeasurement() {
            setBtnLoading(true);
            const resp = await fetch('/trigger-measurement')
                .then(resp => {
                    if (!resp.ok)
                        return;
                    console.log('triggered')

                    setTimeout(() => {
                        console.log('retrieving last measurement')

                        getLastMeasurement().then(() => setBtnLoading(false));
                    }, 2000);
                })
                .catch(err => {
                    console.error(err)
                    setBtnLoading(false);
                })
        }

        async function getLastMeasurement() {
            const resp = await fetch('/last-measurement')

            if (!resp.ok)
                return;

            const data = await resp.json()

            if (data.hexcode) {
                setHexcode(data.hexcode)
            }
        }

        btnTrigger.addEventListener('click', triggerMeasurement);

    </script>
</body>

</html>